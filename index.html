<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Consensus Layer Rewards Estimator</title>
  <!-- Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1242518249448924"
       crossorigin="anonymous"></script>
  <style>
    /* Tooltip styles */
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: pointer;
    }
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 220px;
      background: #222c3a;
      color: #e7eef7;
      text-align: left;
      border-radius: 8px;
      padding: 10px;
      position: absolute;
      z-index: 10;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.2s;
      font-size: 13px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.18);
    }
    .tooltip:hover .tooltiptext, .tooltip:focus .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    .tooltip .info-icon {
      display: inline-block;
      width: 16px;
      height: 16px;
      background: var(--accent-2);
      color: #fff;
      border-radius: 50%;
      text-align: center;
      font-size: 13px;
      line-height: 16px;
      margin-left: 4px;
      vertical-align: middle;
    }
    :root {
      --bg: #0b0f14;
      --panel: #111823;
      --panel-2: #0f1620;
      --text: #e7eef7;
      --text-dim: #a7b3c2;
      --accent: #5eead4;
      --accent-2: #60a5fa;
      --warn: #f59e0b;
      --danger: #ef4444;
      --ok: #22c55e;
      --border: #1f2a37;
      --glow: rgba(96,165,250,.18);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: radial-gradient(1200px 800px at 15% -10%, #0f1a26 0%, var(--bg) 50%), var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, Noto Sans, "Apple Color Emoji", "Segoe UI Emoji";
      line-height: 1.35;
    }
    header {
      padding: 20px 16px 0;
      max-width: 1100px; margin: 0 auto;
    }
    h1 { font-size: 24px; margin: 0 0 6px; letter-spacing: 0.2px; }
    .sub { color: var(--text-dim); font-size: 14px; }

    .container { max-width: 1100px; margin: 16px auto 40px; padding: 0 16px; }

    /* Old .grid kept for compatibility (not used for top Results now) */
    .grid { display: grid; grid-template-columns: 1.1fr 1fr; gap: 16px; }

    /* New: results on top, full width; two-panel grid beneath */
    .results-top { margin-bottom: 16px; }
    .grid-two { display: grid; grid-template-columns: 1.1fr 1fr; gap: 16px; }

    .card {
      position: relative;
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .card h2 { font-size: 16px; margin: 0 0 12px; color: var(--text); }

    /* Sleek & subtle neon treatment (applied to the Results card) */
    .card.neon::before {
      content: "";
      position: absolute; inset: -1px;
      border-radius: 16px;
      background: radial-gradient(600px 200px at 10% -20%, rgba(94,234,212,.12), transparent 60%),
                  radial-gradient(600px 200px at 90% 120%, rgba(96,165,250,.10), transparent 60%);
      pointer-events: none;
      filter: blur(0.2px);
    }
    .card.neon {
      box-shadow:
        0 0 0 1px rgba(99,102,241,0.05),
        0 10px 30px rgba(0,0,0,0.28),
        0 0 40px var(--glow);
      animation: panelBreath 6s ease-in-out infinite;
    }
    @keyframes panelBreath {
      0%,100% { box-shadow: 0 0 0 1px rgba(99,102,241,0.05), 0 10px 30px rgba(0,0,0,0.28), 0 0 28px var(--glow); }
      50%     { box-shadow: 0 0 0 1px rgba(99,102,241,0.08), 0 12px 36px rgba(0,0,0,0.32), 0 0 40px var(--glow); }
    }

    .row { display: grid; grid-template-columns: 1fr 130px; gap: 10px; align-items: center; margin-bottom: 10px; }
    .row .help { color: var(--text-dim); font-size: 12px; margin-top: 2px; }

    label { font-size: 13px; color: var(--text); }
    input[type="number"], select { 
      width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border);
      background: #0b1320; color: var(--text); outline: none; font-size: 14px;
      transition: box-shadow .15s ease, border-color .15s ease, transform .05s ease;
    }
    input[type="number"]:focus, select:focus {
      border-color: var(--accent-2);
      box-shadow: 0 0 0 3px rgba(96,165,250,.15), 0 0 18px rgba(96,165,250,.10);
    }
    input[type="range"] { width: 100%; }
    .pct { display:flex; gap:8px; align-items:center; }

    .muted { color: var(--text-dim); font-size: 12px; }

    .outputs { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 12px; }
    .metric {
      background: #0c1420;
      border:1px solid var(--border);
      padding: 12px; border-radius: 12px;
      transition: transform .08s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .metric:hover {
      transform: translateY(-1px);
      border-color: #2a3950;
      box-shadow: 0 0 22px rgba(94,234,212,.08), inset 0 0 0 1px rgba(255,255,255,0.02);
    }
    .metric .label { color: var(--text-dim); font-size: 12px; letter-spacing:.2px; }
    .metric .value { font-size: 20px; margin-top: 6px; }

    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; font-size:11px; border:1px solid var(--border); color: var(--text-dim); }

    .footer { margin-top: 14px; font-size: 12px; color: var(--text-dim); }

    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
      .grid-two { grid-template-columns: 1fr; }
      .outputs { grid-template-columns: 1fr; }
    }
    .hr { height:1px; background: var(--border); margin:12px 0; border-radius:1px; }
    .kicker { font-size: 12px; color: var(--text-dim); }
    .hint { color: var(--accent-2); font-size: 12px; }

    .inline { display:flex; gap:8px; align-items:center; }

    .badge-ok { color: var(--ok); }
    .badge-warn { color: var(--warn); }
    .badge-danger { color: var(--danger); }

    /* Footer styles */
    .site-footer {
      margin-top: 60px;
      border-top: 1px solid var(--border);
      background: var(--panel-2);
      padding: 32px 16px;
    }
    .site-footer .container {
      max-width: 1100px;
      margin: 0 auto;
      text-align: center;
    }
    .footer-content {
      display: flex;
      flex-direction: column;
      gap: 16px;
      align-items: center;
    }
    .footer-links {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .footer-links a {
      color: var(--accent-2);
      text-decoration: none;
      font-size: 14px;
      transition: color 0.2s;
    }
    .footer-links a:hover {
      color: var(--accent);
    }
    .footer-text {
      color: var(--text-dim);
      font-size: 13px;
      max-width: 600px;
    }
    .github-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--panel);
      border: 1px solid var(--border);
      padding: 8px 12px;
      border-radius: 8px;
      text-decoration: none;
      color: var(--text);
      font-size: 13px;
      transition: all 0.2s;
    }
    .github-link:hover {
      border-color: var(--accent-2);
      background: var(--panel-2);
    }
    .github-icon {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }

    /* Ad container styling */
    .ad-container {
      text-align: center;
      margin: 20px auto;
      max-width: 1100px;
      padding: 0 16px;
    }
    .inline-ad {
      text-align: center;
      margin: 16px 0;
      padding: 12px;
      background: #0c1420;
      border: 1px solid var(--border);
      border-radius: 12px;
    }

    @media (max-width: 600px) {
      .footer-links { flex-direction: column; gap: 12px; }
      .footer-content { gap: 20px; }
    }

    /* Top navigation bar (unchanged) */
    .topnav {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      backdrop-filter: saturate(1.2) blur(4px);
    }
    .topnav-inner {
      max-width: 1100px;
      margin: 0 auto;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .brand {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      letter-spacing: .2px;
      color: var(--text);
      text-decoration: none;
    }
    .brand-dot {
      width: 8px; height: 8px; border-radius: 999px; background: var(--accent);
      box-shadow: 0 0 12px rgba(94,234,212,.6);
      animation: dotPulse 3.8s ease-in-out infinite;
    }
    @keyframes dotPulse {
      0%,100% { transform: scale(1); box-shadow: 0 0 10px rgba(94,234,212,.55); }
      50%     { transform: scale(1.2); box-shadow: 0 0 16px rgba(94,234,212,.75); }
    }
    .nav-actions { display: inline-flex; align-items: center; gap: 8px; }
    .btn-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      font-size: 13px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0b1320;
      color: var(--text);
      text-decoration: none;
      transition: border-color .2s, transform .05s ease-in-out, box-shadow .2s;
    }
    .btn-link:hover { border-color: var(--accent-2); box-shadow: 0 0 12px rgba(96,165,250,.12); }
    .btn-link:active { transform: translateY(1px); }
    .btn-primary {
      background: linear-gradient(180deg, var(--accent-2), #3b82f6);
      color: #021021;
      border: 1px solid #375cbd33;
    }
    .btn-primary:hover { filter: brightness(1.05); }
  </style>
</head>
<body>

  <!-- Top navigation -->
  <nav class="topnav">
    <div class="topnav-inner">
      <a href="#" class="brand" title="CL Rewards Estimator">
        <span class="brand-dot"></span>
        <span>CL Rewards Estimator</span>
      </a>
      <div class="nav-actions">
        <a class="btn-link" href="https://github.com/sajz/CL-Rewards-Estimator" target="_blank" rel="noopener noreferrer">GitHub</a>
        <a class="btn-link btn-primary" href="https://github.com/sajz/CL-Rewards-Estimator/blob/main/documentation.md" target="_blank" rel="noopener noreferrer">Docs</a>
      </div>
    </div>
  </nav>

  <header>
    <h1>Consensus Layer Reward Estimator</h1>
    <div class="sub">Estimate your Ethereum validator rewards and see how network latency impacts your earnings.</div>
    <div class="muted" style="margin-top:8px; font-size:15px;">
      <strong>What does this tool answer?</strong><br>
      <ul style="margin:8px 0 0 18px; padding:0;">
        <li>How much ETH can I earn per year as a validator?</li>
        <li>How do my participation rates and latency affect my rewards?</li>
        <li>What happens if I improve my network latency?</li>
      </ul>
    </div>
  </header>

  <!-- Top Banner Ad -->
  <div class="ad-container">
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-1242518249448924"
         data-ad-slot="1234567890"
         data-ad-format="auto"
         data-full-width-responsive="true"></ins>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
  </div>

  <div class="container">

    <!-- RESULTS: moved to top, full width, with subtle neon -->
    <section class="card neon results-top">
      <h2>Results
        <span class="tooltip" tabindex="0">
          <span class="info-icon">i</span>
          <span class="tooltiptext">
            <strong>Formula:</strong><br>
            MER = (14×Source + 26×Target + 14×Head + 8×Proposer + 2×Sync) / 64<br>
            ETH/year = MER × Baseline ETH<br>
            APR = MER × Baseline APR
          </span>
        </span>
      </h2>
      <div class="outputs">
        <div class="metric">
          <div class="label">MER (%)</div>
          <div id="mer_pct" class="value">—</div>
        </div>
        <div class="metric">
          <div class="label">CL APR (%)</div>
          <div id="apr_pct" class="value">—</div>
        </div>
        <div class="metric">
          <div class="label">CL rewards (ETH / validator / year)</div>
          <div id="eth_year" class="value">—</div>
        </div>
      </div>

      <!-- Inline Ad stays within Results -->
      <div class="inline-ad">
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-1242518249448924"
             data-ad-slot="2345678901"
             data-ad-format="auto"></ins>
        <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      </div>

      <div class="outputs" style="margin-top:12px;">
        <div class="metric">
          <div class="label">Fleet total (ETH / year)</div>
          <div id="fleet_eth" class="value">—</div>
        </div>
        <div class="metric">
          <div class="label">ETH → USD (per validator / year)</div>
          <div id="usd_year" class="value">—</div>
        </div>
        <div class="metric">
          <div class="label">Fleet total (USD / year)</div>
          <div id="fleet_usd" class="value">—</div>
        </div>
      </div>
      <div class="footer">
        <div class="kicker">Formula</div>
        <div class="muted">
          <span class="hint">MER fraction</span> = (14×Source + 26×Target + 14×Head + 8×Proposer + 2×Sync) / 64, with each term multiplied by its <em>timely participation rate</em>.<br />
          <span class="hint">ETH/year</span> = Baseline_ETH × MER_fraction. &nbsp; <span class="hint">APR</span> = Baseline_APR × MER_fraction.
        </div>
        <div class="kicker" style="margin-top:8px;">Notes</div>
        <ul class="muted">
          <li>Consensus-layer only (excludes EL/fees/MEV). Baseline 0.997 ETH ≈ 3.11% APR.</li>
          <li>Head has <em>no penalty</em> if wrong/missed after Altair; you simply don't earn it. Target/Source can incur penalties during inactivity leak periods (not modeled here).</li>
        </ul>
      </div>
    </section>

    <!-- BELOW: two panels side-by-side (Inputs + Latency beta) -->
    <div class="grid-two">
      <!-- Inputs -->
      <section class="card">
        <h2>Inputs (timely participation, %)</h2>
        <div class="row">
          <label>Target flag (timely within 32 slots)</label>
          <div class="pct">
            <input id="p_target" type="number" min="0" max="100" step="0.1" value="96"/>
            <span class="pill">26/64 weight</span>
          </div>
        </div>
        <div class="row">
          <label>Head flag (timely = inclusion delay 1 slot)</label>
          <div class="pct">
            <input id="p_head" type="number" min="0" max="100" step="0.1" value="93"/>
            <span class="pill">14/64 weight</span>
          </div>
        </div>
        <div class="row">
          <label>Source flag (timely within 5 slots)</label>
          <div class="pct">
            <input id="p_source" type="number" min="0" max="100" step="0.1" value="98"/>
            <span class="pill">14/64 weight</span>
          </div>
        </div>
        <div class="row">
          <label>Missed proposals (as % of your proposals)</label>
          <div class="pct">
            <input id="miss_proposals" type="number" min="0" max="100" step="0.1" value="0"/>
            <span class="pill">Proposer 8/64</span>
          </div>
        </div>
        <div class="row">
          <label>Missed sync duties (as % when selected)</label>
          <div class="pct">
            <input id="miss_sync" type="number" min="0" max="100" step="0.1" value="0"/>
            <span class="pill">Sync 2/64</span>
          </div>
        </div>
        <div class="hr"></div>
        <h2>Baseline & fleet</h2>
        <div class="row">
          <label>Baseline @ 100% MER (ETH/validator/year)</label>
          <input id="baseline_eth" type="number" step="0.001" value="0.997"/>
        </div>
        <div class="row">
          <label>Baseline APR @ 100% MER (%)</label>
          <input id="baseline_apr" type="number" step="0.001" value="3.11"/>
        </div>
        <div class="row">
          <label>Number of validators</label>
          <input id="n_validators" type="number" step="1" value="1"/>
        </div>
        <div class="row">
          <label>ETH price (optional, $)</label>
          <input id="eth_price" type="number" step="1" value="3000"/>
        </div>
        <div class="muted">Weights from Altair: Source 14, Target 26, Head 14, Proposer 8, Sync 2 (sum 64). Change only the participation rates above.
        </div>
      </section>

      <!-- Latency → Predicted duties (beta) -->
      <section class="card">
        <h2>Latency gain - BETA</h2>
      
        <div class="row">
          <label>Current p90 block arrival (s)</label>
          <input id="simp_p90_now" type="number" step="0.01" value="4.15"/>
        </div>
        <div class="row">
          <label>Improve p90 by (ms)</label>
          <input id="simp_improve_ms" type="number" step="10" value="200"/>
        </div>
        <div class="row">
          <label>Offline rate (%)</label>
          <input id="lat_offline" type="number" min="0" max="100" step="0.1" value="0"/>
        </div>
      
        <div class="hr"></div>
        <h2>Predicted (from p90)</h2>
        <div class="outputs">
          <div class="metric">
            <div class="label">p90 after (s)</div>
            <div id="simp_p90_after" class="value">—</div>
          </div>
          <div class="metric">
            <div class="label">MER now (%)</div>
            <div id="simp_mer_now" class="value">—</div>
          </div>
          <div class="metric">
            <div class="label">Δ MER vs current (%)</div>
            <div id="simp_delta_mer_now" class="value">—</div>
          </div>
          <div class="metric">
            <div class="label">Δ ETH / validator / yr</div>
            <div id="simp_delta_eth_now" class="value">—</div>
          </div>
        </div>

      
        <div class="outputs" style="margin-top:12px;">
          <div class="metric">
            <div class="label">MER after improvement (%)</div>
            <div id="simp_mer_after" class="value">—</div>
          </div>
          <div class="metric">
            <div class="label">Δ MER vs current (%)</div>
            <div id="simp_delta_mer_after" class="value">—</div>
          </div>
          <div class="metric">
            <div class="label">Δ ETH / validator / yr</div>
            <div id="simp_delta_eth_after" class="value">—</div>
          </div>
        </div>
      
        <div class="footer">
          <div class="muted">
            Linear mapping anchored at p90=3.6s → ~80% MER and p90=4.3s → ~74.3% MER.
            Overheads belong in p90 itself or in the offline field. Anchors are editable in <code>latency_mer_model.js</code>.
          </div>
        </div>
      </section>

    </div>
  </div>

  <!-- Footer Ad -->
  <div class="ad-container">
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-1242518249448924"
         data-ad-slot="3456789012"
         data-ad-format="auto"
         data-full-width-responsive="true"></ins>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
  </div>

  <footer class="site-footer">
    <div class="container">
      <div class="footer-content">
        <a href="https://github.com/sajz/CL-Rewards-Estimator" class="github-link" target="_blank" rel="noopener noreferrer">
          <svg class="github-icon" viewBox="0 0 24 24">
            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
          </svg>
          View Source on GitHub
        </a>

        <div class="footer-links">
          <a href="https://ethereum.org/en/staking/" target="_blank" rel="noopener noreferrer">Ethereum Staking</a>
          <a href="https://launchpad.ethereum.org/" target="_blank" rel="noopener noreferrer">Staking Launchpad</a>
          <a href="https://beaconcha.in/" target="_blank" rel="noopener noreferrer">Beacon Chain Explorer</a>
          <a href="https://github.com/ethereum/consensus-specs" target="_blank" rel="noopener noreferrer">Consensus Specs</a>
        </div>

        <div class="footer-text">
          <p><strong>Open Source & Free to Use</strong> • This tool is completely free and open source. Calculate Ethereum consensus layer rewards based on participation rates and validator performance.</p>
          <p>⚠️ <em>For educational purposes only. Not financial advice. Actual rewards may vary based on network conditions, slashing events, and other factors not modeled here.</em></p>
        </div>
      </div>
    </div>
  </footer>

  <script>
    const W = { source: 14, target: 26, head: 14, proposer: 8, sync: 2, denom: 64 };

    function clamp01(x) { return Math.max(0, Math.min(1, x)); }

    function fmt(n, d=2) {
      if (!isFinite(n)) return '—';
      return n.toLocaleString(undefined, { maximumFractionDigits: d, minimumFractionDigits: d });
    }

    function recalc() {
      const p_source = clamp01(parseFloat(document.getElementById('p_source').value || 0) / 100);
      const p_target = clamp01(parseFloat(document.getElementById('p_target').value || 0) / 100);
      const p_head   = clamp01(parseFloat(document.getElementById('p_head').value   || 0) / 100);

      const miss_prop = clamp01(parseFloat(document.getElementById('miss_proposals').value || 0) / 100);
      const miss_sync = clamp01(parseFloat(document.getElementById('miss_sync').value || 0) / 100);
      const p_prop = 1 - miss_prop;
      const p_sync = 1 - miss_sync;

      const baseline_eth = parseFloat(document.getElementById('baseline_eth').value || 0.997);
      const baseline_apr = parseFloat(document.getElementById('baseline_apr').value || 3.11);
      const n_val = Math.max(1, parseInt(document.getElementById('n_validators').value || '1', 10));
      const eth_price = parseFloat(document.getElementById('eth_price').value || 0);

      const weighted = (W.source * p_source + W.target * p_target + W.head * p_head + W.proposer * p_prop + W.sync * p_sync);
      const mer_frac = weighted / W.denom;

      const mer_pct = mer_frac * 100;
      const apr_pct = mer_frac * baseline_apr;
      const eth_year = mer_frac * baseline_eth;

      const fleet_eth = eth_year * n_val;
      const usd_year = eth_price ? eth_year * eth_price : NaN;
      const fleet_usd = eth_price ? fleet_eth * eth_price : NaN;

      document.getElementById('mer_pct').textContent = fmt(mer_pct, 2) + ' %';
      document.getElementById('apr_pct').textContent = fmt(apr_pct, 3) + ' %';
      document.getElementById('eth_year').textContent = fmt(eth_year, 4) + ' ETH';

      document.getElementById('fleet_eth').textContent = fmt(fleet_eth, 3) + ' ETH';
      document.getElementById('usd_year').textContent = isFinite(usd_year) ? ('$' + fmt(usd_year, 0)) : '—';
      document.getElementById('fleet_usd').textContent = isFinite(fleet_usd) ? ('$' + fmt(fleet_usd, 0)) : '—';
    }

    document.querySelectorAll('input').forEach(el => el.addEventListener('input', recalc));
    recalc();
  </script>

<!-- Tail-Deadline Panel (MER from p50 & p90) -->
<section class="card" id="tail-deadline-panel">
  <h2>Tail-Deadline Model (MER from p50 & p90)
    <span class="tooltip" tabindex="0">
      <span class="info-icon">i</span>
      <span class="tooltiptext">
        <strong>Technical:</strong><br>
        Lognormal fit from p50 & p90.<br>
        Tail fraction after soft deadline (4.0 − δ).<br>
        MER = 85.373 − 74.608·q (center)<br>
        q = fraction of arrivals after deadline.
      </span>
    </span>
  </h2>

  <div class="row">
    <label>p50 block arrival (s)</label>
    <input id="tail_p50" type="number" step="0.01" value="2.18" />
  </div>

  <div class="row">
    <label>p90 block arrival (s)</label>
    <input id="tail_p90" type="number" step="0.01" value="4.15" />
  </div>

  <div class="row">
    <label>Processing overhead δ (s) <span class="muted">(V1: leave 0)</span></label>
    <input id="tail_delta" type="number" step="0.01" value="0" />
  </div>

  <div class="muted" style="margin-top:6px">
    Uses a lognormal fit from p50 & p90 to estimate the fraction of arrivals after the 4.0s deadline, then maps that “tail” linearly to MER with a small uncertainty band.
  </div>

  <div class="outputs" style="margin-top:12px;">
    <div class="metric">
      <div class="label">Tail &gt; 4s (q)</div>
      <div id="tail_q" class="value">—</div>
    </div>
    <div class="metric">
      <div class="label">Predicted MER (center)</div>
      <div id="tail_mer_center" class="value">—</div>
    </div>
    <div class="metric">
      <div class="label">Predicted MER (range)</div>
      <div id="tail_mer_range" class="value">—</div>
    </div>
  </div>

  <div class="outputs" style="margin-top:12px;">
    <div class="metric">
      <div class="label">ETH/yr per validator (center)</div>
      <div id="tail_eth_center" class="value">—</div>
    </div>
    <div class="metric">
      <div class="label">ETH/yr per validator (range)</div>
      <div id="tail_eth_range" class="value">—</div>
    </div>
    <div class="metric">
      <div class="label">Δ vs your current (MER / ETH)</div>
      <div id="tail_delta_vs_user" class="value">—</div>
    </div>
  </div>

  <div class="footer">
    <div class="kicker">Model</div>
    <div class="muted">
      Fit lognormal from p50, p90; compute <em>q = P(T &gt; 4s−δ)</em>; map with: <br/>
      <span class="hint">MER<sub>center</sub>(q)</span> = 85.373 − 74.608·q; &nbsp;
      <span class="hint">MER<sub>upper</sub>(q)</span> = 85.300 − 59.923·q; &nbsp;
      <span class="hint">MER<sub>lower</sub>(q)</span> = 85.446 − 89.292·q; &nbsp;
      clamped to [70, 86].
    </div>
  </div>
</section>

<script type="module">
  import { tailFractionAfterDeadline, merFromTailFraction } from './latency_mer_model.js';

  const fmt = (n, d=2) => Number.isFinite(n) ? n.toLocaleString(undefined, {maximumFractionDigits:d, minimumFractionDigits:d}) : '—';

  // Read current MER fraction from main panel if available; else compute from inputs
  function readUserMERFrac() {
    if (typeof window.readUserMERFrac === 'function') return window.readUserMERFrac();
    const W = { source:14, target:26, head:14, proposer:8, sync:2, denom:64 };
    const clamp01 = x => Math.max(0, Math.min(1, x));
    const g = id => parseFloat((document.getElementById(id)?.value)||'0');
    const p_source = clamp01(g('p_source')/100);
    const p_target = clamp01(g('p_target')/100);
    const p_head   = clamp01(g('p_head')/100);
    const miss_prop= clamp01(g('miss_proposals')/100);
    const miss_sync= clamp01(g('miss_sync')/100);
    const p_prop = 1 - miss_prop;
    const p_sync = 1 - miss_sync;
    const weighted = (W.source*p_source + W.target*p_target + W.head*p_head + W.proposer*p_prop + W.sync*p_sync);
    return weighted / W.denom;
  }

  function recalcTailPanel(){
    const p50 = parseFloat(document.getElementById('tail_p50').value);
    const p90 = parseFloat(document.getElementById('tail_p90').value);
    const delta = parseFloat(document.getElementById('tail_delta').value) || 0;
    const deadline = 4;
    const q = tailFractionAfterDeadline(p50, p90, delta, deadline);
    const baselineEth = parseFloat(document.getElementById('baseline_eth')?.value || '0.997');
    const ethPerMerPt = baselineEth / 100;
    const mer = merFromTailFraction(q);
    // Convert to ETH/yr per validator
    const ethC  = (mer.center / 100) * baselineEth;
    const ethHi = (mer.upper / 100) * baselineEth;
    const ethLo = (mer.lower / 100) * baselineEth;
    // Delta vs current user MER (from main panel)
    const userFrac = readUserMERFrac();
    const userMerPct = userFrac * 100;
    const dMer = mer.center - userMerPct;
    const dEth = dMer * ethPerMerPt;
    // Write UI
    document.getElementById('tail_q').textContent = Number.isFinite(q) ? fmt(q*100, 2) + ' %' : '—';
    document.getElementById('tail_mer_center').textContent = fmt(mer.center, 2) + ' %';
    document.getElementById('tail_mer_range').textContent  = fmt(mer.lower, 2) + '–' + fmt(mer.upper, 2) + ' %';
    document.getElementById('tail_eth_center').textContent = fmt(ethC, 4) + ' ETH';
    document.getElementById('tail_eth_range').textContent  = fmt(ethLo, 4) + '–' + fmt(ethHi, 4) + ' ETH';
    const sign = dMer >= 0 ? '+' : '';
    document.getElementById('tail_delta_vs_user').textContent =
      sign + fmt(dMer, 2) + ' %  /  ' + (dEth>=0?'+':'') + fmt(dEth, 4) + ' ETH';
  }

  [
    'tail_p50','tail_p90','tail_delta','baseline_eth','p_source','p_target','p_head','miss_proposals','miss_sync'
  ].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('input', recalcTailPanel);
      el.addEventListener('change', recalcTailPanel);
    }
  });

  recalcTailPanel();
</script>




</body>
</html>



